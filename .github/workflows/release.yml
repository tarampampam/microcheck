# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# docs: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions

name: ðŸš€ Release

on:
  release: # Docs: <https://git.io/JeBz1#release-event-release>
    types: [published]

jobs:
  docker-image:
    name: Build the docker image
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.push.outputs.digest }}
      tags: ${{ steps.tags.outputs.list }}
    steps:
      - uses: actions/checkout@v5
      - {uses: gacts/github-slug@v1, id: slug}
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with: {username: tarampampam, password: '${{ secrets.DOCKER_PASSWORD }}'}
      - uses: docker/login-action@v3
        with: {registry: quay.io, username: '${{ secrets.QUAY_LOGIN }}', password: '${{ secrets.QUAY_PASSWORD }}'}
      - uses: docker/login-action@v3
        with: {registry: ghcr.io, username: '${{ github.actor }}', password: '${{ secrets.GITHUB_TOKEN }}'}
      - id: tags
        env:
          HUB_IMAGE: tarampampam/microcheck
          GHCR_IMAGE: ghcr.io/${{ github.repository }}
          QUAY_IMAGE: quay.io/tarampampam/microcheck
          EXACT: ${{ steps.slug.outputs.version-semantic }}
          MINOR: ${{ steps.slug.outputs.version-major }}.${{ steps.slug.outputs.version-minor }}
          MAJOR: ${{ steps.slug.outputs.version-major }}
        run: |
          echo 'list<<EOF' >> $GITHUB_OUTPUT
          echo "$HUB_IMAGE:$EXACT" >> "$GITHUB_OUTPUT"
          echo "$HUB_IMAGE:$MINOR" >> "$GITHUB_OUTPUT"
          echo "$HUB_IMAGE:$MAJOR" >> "$GITHUB_OUTPUT"
          echo "$HUB_IMAGE:latest" >> "$GITHUB_OUTPUT"
          echo "$GHCR_IMAGE:$EXACT" >> "$GITHUB_OUTPUT"
          echo "$GHCR_IMAGE:$MINOR" >> "$GITHUB_OUTPUT"
          echo "$GHCR_IMAGE:$MAJOR" >> "$GITHUB_OUTPUT"
          echo "$GHCR_IMAGE:latest" >> "$GITHUB_OUTPUT"
          echo "$QUAY_IMAGE:$EXACT" >> "$GITHUB_OUTPUT"
          echo "$QUAY_IMAGE:$MINOR" >> "$GITHUB_OUTPUT"
          echo "$QUAY_IMAGE:$MAJOR" >> "$GITHUB_OUTPUT"
          echo "$QUAY_IMAGE:latest" >> "$GITHUB_OUTPUT"
          echo 'EOF' >> $GITHUB_OUTPUT
      - uses: docker/build-push-action@v6
        id: push
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/ppc64le,linux/s390x # <-- important
          build-args: APP_VERSION=${{ steps.slug.outputs.version-semantic }}
          tags: ${{ steps.tags.outputs.list }}

  update-release-note:
    name: Update release note
    runs-on: ubuntu-latest
    needs: [docker-image]
    steps:
      - uses: actions/github-script@v6
        env: {IMAGE_TAGS: '${{ needs.docker-image.outputs.tags }}'}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: ((await github.rest.repos.getRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: context.payload.release.id
              })).data.body || '') +
              "\n## ðŸ‹ Docker images\n\n```cpp\n" + (process.env.IMAGE_TAGS || '').trim() + "\n```\n"
            })

  binary-files:
    name: Publish the binary files (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [docker-image]
    strategy:
      matrix:
        platform: # the list should be the same as the platforms listed above
          - linux/386
          - linux/amd64
          - linux/arm/v6
          - linux/arm/v7
          - linux/arm64/v8
          - linux/ppc64le
          - linux/s390x
    steps:
      - uses: actions/checkout@v5
      - {uses: gacts/github-slug@v1, id: slug}
      - uses: docker/login-action@v3
        with: {registry: ghcr.io, username: '${{ github.actor }}', password: '${{ secrets.GITHUB_TOKEN }}'}
      - run: |
          docker pull --platform "${{ matrix.platform }}" ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-semantic }}
          docker create --name app --platform "${{ matrix.platform }}" ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-semantic }} /noop
          mkdir ./dist
          docker cp app:/bin/httpcheck ./dist/httpcheck
          docker cp app:/bin/httpscheck ./dist/httpscheck
          docker cp app:/bin/portcheck ./dist/portcheck
          docker cp app:/bin/parallel ./dist/parallel
          cd ./dist
          tar -czf ../release.tar.gz *
          zip -r ../release.zip .
      - {uses: gacts/github-slug@v1, id: filename, with: {to-slug: '${{ matrix.platform }}'}}
      - uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./release.tar.gz
          asset_name: ${{ steps.filename.outputs.slug }}.tar.gz
          tag: ${{ github.ref }}
      - uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./release.zip
          asset_name: ${{ steps.filename.outputs.slug }}.zip
          tag: ${{ github.ref }}

  generate-checksums:
    name: Generate checksums.txt
    runs-on: ubuntu-latest
    needs: [binary-files]
    steps:
      - uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.ref_name }}
          fileName: '*'
          token: ${{ secrets.GITHUB_TOKEN }}
          out-file-path: 'artifacts'
      - working-directory: ./artifacts
        run: shasum -a 256 * > checksums.txt
      - uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./artifacts/checksums.txt
          asset_name: checksums.txt
          tag: ${{ github.ref }}
