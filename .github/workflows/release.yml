# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# docs: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions

name: ðŸš€ Release

on:
  release: # Docs: <https://git.io/JeBz1#release-event-release>
    types: [published]

jobs:
  docker-image:
    name: Build the docker image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - {uses: gacts/github-slug@v1, id: slug}
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with: {username: '${{ secrets.DOCKER_LOGIN }}', password: '${{ secrets.DOCKER_PASSWORD }}'}
      - uses: docker/login-action@v3
        with: {registry: quay.io, username: '${{ secrets.QUAY_LOGIN }}', password: '${{ secrets.QUAY_PASSWORD }}'}
      - uses: docker/login-action@v3
        with: {registry: ghcr.io, username: '${{ github.actor }}', password: '${{ secrets.GITHUB_TOKEN }}'}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/ppc64le,linux/s390x # <-- important
          build-args: APP_VERSION=${{ steps.slug.outputs.version-semantic }}
          tags: |
            tarampampam/microcheck:latest
            tarampampam/microcheck:${{ steps.slug.outputs.version-semantic }}
            tarampampam/microcheck:${{ steps.slug.outputs.version-major }}
            tarampampam/microcheck:${{ steps.slug.outputs.version-major }}.${{ steps.slug.outputs.version-minor }}
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-semantic }}
            ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-major }}
            ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-major }}.${{ steps.slug.outputs.version-minor }}
            quay.io/tarampampam/microcheck:latest
            quay.io/tarampampam/microcheck:${{ steps.slug.outputs.version-semantic }}
            quay.io/tarampampam/microcheck:${{ steps.slug.outputs.version-major }}
            quay.io/tarampampam/microcheck:${{ steps.slug.outputs.version-major }}.${{ steps.slug.outputs.version-minor }}
  binary-files:
    name: Publish the binary files (${{ matrix.platform }})
    runs-on: ubuntu-latest
    needs: [docker-image]
    strategy:
      matrix:
        platform: # the list should be the same as the platforms listed above
          - linux/386
          - linux/amd64
          - linux/arm/v6
          - linux/arm/v7
          - linux/arm64/v8
          - linux/ppc64le
          - linux/s390x
    steps:
      - uses: actions/checkout@v5
      - {uses: gacts/github-slug@v1, id: slug}
      - uses: docker/login-action@v3
        with: {registry: ghcr.io, username: '${{ github.actor }}', password: '${{ secrets.GITHUB_TOKEN }}'}
      - run: |
          docker pull --platform "${{ matrix.platform }}" ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-semantic }}
          docker create --name app --platform "${{ matrix.platform }}" ghcr.io/${{ github.repository }}:${{ steps.slug.outputs.version-semantic }} /noop
          mkdir ./dist
          docker cp app:/bin/httpcheck ./dist/httpcheck
          docker cp app:/bin/httpscheck ./dist/httpscheck
          docker cp app:/bin/portcheck ./dist/portcheck
          docker cp app:/bin/parallel ./dist/parallel
          cd ./dist
          tar -czf ../release.tar.gz *
          zip -r ../release.zip .
      - {uses: gacts/github-slug@v1, id: filename, with: {to-slug: '${{ matrix.platform }}'}}
      - uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./release.tar.gz
          asset_name: ${{ steps.filename.outputs.slug }}.tar.gz
          tag: ${{ github.ref }}
      - uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./release.zip
          asset_name: ${{ steps.filename.outputs.slug }}.zip
          tag: ${{ github.ref }}
