#!/usr/bin/make

version ?= 0.0.0

CC = musl-gcc
C_SIZE_FLAGS = -Os -ffunction-sections -fdata-sections
C_SECURITY_FLAGS = -fstack-protector-strong -D_FORTIFY_SOURCE=2
C_WARNING_FLAGS = -Wall -Wextra -Werror -Wpedantic -Wformat=2 -Wformat-security \
	-Wnull-dereference -Wstack-protector -Wstrict-overflow=3 \
	-Wwrite-strings -Wconversion -Wshadow
C_STRIP_FLAGS = -s -fno-asynchronous-unwind-tables -fno-ident -Wl,--build-id=none
C_LDFLAGS = -static -Wl,--gc-sections
CFLAGS = $(C_SIZE_FLAGS) $(C_SECURITY_FLAGS) $(C_WARNING_FLAGS) $(C_STRIP_FLAGS) $(C_LDFLAGS)
STRIP_FLAGS = -s -R .comment -R .gnu.version -R .note -R .note.ABI-tag

.PHONY: src/version.h httpcheck test clean

all: httpcheck

httpcheck: src/httpcheck.c src/version.h
	$(CC) $(CFLAGS) -o $@ $<
	strip $(STRIPFLAGS) $@
	@file $@
	@stat -c 'file size: %s bytes' $@

.PHONY:
src/version.h:
	@printf '// Code generated by `make version.h`; DO NOT EDIT.\n\n#define APP_VERSION "%s"\n' "$(version)" > $@

test: httpcheck
	$(SHELL) ./test/httpcheck.sh ./httpcheck

clean:
	rm -f httpcheck
