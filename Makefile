#!/usr/bin/make

APP_VERSION ?= 0.0.0

CC              := musl-gcc
C_SIZE_FLAGS     = -Os -ffunction-sections -fdata-sections
C_SECURITY_FLAGS = -fstack-protector-strong -D_FORTIFY_SOURCE=2
C_WARNING_FLAGS  = -Wall -Wextra -Werror -Wpedantic -Wformat=2 -Wformat-security -Wnull-dereference \
	-Wstack-protector -Wstrict-overflow=3 -Wwrite-strings -Wconversion -Wshadow
C_STRIP_FLAGS    = -s -fno-asynchronous-unwind-tables -fno-ident -Wl,--build-id=none
C_LDFLAGS        = -static -Wl,--gc-sections
CFLAGS           = $(C_SIZE_FLAGS) $(C_SECURITY_FLAGS) $(C_WARNING_FLAGS) $(C_STRIP_FLAGS) $(C_LDFLAGS)
STRIP_FLAGS      = -s -R .comment -R .gnu.version -R .note -R .note.ABI-tag

MBEDTLS_DIR                   = libs/mbedtls4
MBEDTLS_BUILD_DIR             = $(MBEDTLS_DIR)/build
MBEDTLS_INCLUDE               = $(MBEDTLS_DIR)/include
MBEDTLS_TFPSA_INCLUDE         = $(MBEDTLS_DIR)/tf-psa-crypto/include
MBEDTLS_TFPSA_BUILTIN_INCLUDE = $(MBEDTLS_DIR)/tf-psa-crypto/drivers/builtin/include
MBEDTLS_LIB_DIR               = $(MBEDTLS_BUILD_DIR)/library

.ONESHELL:
.DEFAULT_GOAL : all
.PHONY: src/version.h clean

all: httpcheck httpscheck

.PHONY: $(MBEDTLS_DIR)
$(MBEDTLS_DIR):
	@if [ ! -d $(MBEDTLS_DIR) ]; then \
		mkdir -p ./libs; \
		echo "Downloading mbedtls"; \
		wget -O ./libs/mbedtls.tar.bz2 --quiet \
			"https://github.com/Mbed-TLS/mbedtls/releases/download/mbedtls-4.0.0/mbedtls-4.0.0.tar.bz2"; \
		echo "Extracting mbedtls"; \
		tar -xjf ./libs/mbedtls.tar.bz2 -C ./libs; \
		rm ./libs/mbedtls.tar.bz2; \
		mv ./libs/mbedtls-4.0.0 $(MBEDTLS_DIR); \
	else \
		echo "mbedtls already downloaded"; \
	fi
	@if [ ! -d $(MBEDTLS_BUILD_DIR) ]; then \
		mkdir -p $(MBEDTLS_BUILD_DIR); \
		echo "Building mbedtls"; \
		cd $(MBEDTLS_BUILD_DIR); \
		CC=$(CC) cmake \
			-DCMAKE_BUILD_TYPE=MinSizeRel \
		  -DCMAKE_C_FLAGS="-Os -ffunction-sections -fdata-sections" \
			-DENABLE_TESTING=OFF \
			-DENABLE_PROGRAMS=OFF \
			-DUSE_SHARED_MBEDTLS_LIBRARY=OFF \
			.. \
		&& cmake --build . --target lib -j$(shell nproc); \
	else \
		echo "mbedtls already built"; \
	fi

httpcheck: src/httpcheck.c src/version.h
	$(CC) $(CFLAGS) -o $@ $<
	strip $(STRIP_FLAGS) $@
	@file $@
	@stat -c 'file size: %s bytes' $@

httpscheck: src/httpcheck.c src/version.h $(MBEDTLS_DIR)
	$(CC) $(CFLAGS) -DWITH_TLS \
		-I$(MBEDTLS_INCLUDE) \
		-I$(MBEDTLS_TFPSA_INCLUDE) \
		-I$(MBEDTLS_TFPSA_BUILTIN_INCLUDE) \
		-L$(MBEDTLS_LIB_DIR) \
		-o $@ $< \
		-lmbedtls -lmbedx509 -ltfpsacrypto
	strip $(STRIP_FLAGS) $@
	@file $@
	@stat -c 'file size: %s bytes' $@

src/version.h:
	@printf '// Code generated by `make`; DO NOT EDIT.\n\n#ifndef VERSION_H\n#define VERSION_H\n#define APP_VERSION "%s"\n#endif\n' "$(APP_VERSION)" > $@

test: httpcheck httpscheck
	python3 ./test/httpcheck.py --bin ./httpcheck
	python3 ./test/httpcheck.py --bin ./httpscheck --https
	python3 ./test/httpcheck.py --bin ./httpscheck

clean:
	rm ./httpcheck ./httpscheck
